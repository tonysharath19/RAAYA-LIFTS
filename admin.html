<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>RAAYA COMMAND | ADMIN</title>
<link href="https://fonts.googleapis.com/css2?family=Syncopate:wght@400;700&family=Inter:wght@300;600;800&display=swap" rel="stylesheet">
<style>
    :root{--neon:#00F2FF;--warn:#FF3131;--success:#00ff88;--gold:#FFD700;--bg:#050a0f;--panel:rgba(255,255,255,0.02);--border:rgba(0,242,255,0.2)}
    *{margin:0;padding:0;box-sizing:border-box;scrollbar-width:thin;scrollbar-color:var(--neon) #000}
    body{background:var(--bg);color:#fff;font-family:'Inter',sans-serif;height:100vh;overflow:hidden;display:flex}
    
    /* SIDEBAR */
    .sidebar{width:250px;background:rgba(0,0,0,0.95);border-right:1px solid var(--border);padding:20px;display:flex;flex-direction:column;gap:10px; transition: transform 0.3s ease; z-index: 3000;}
    .logo{font-family:'Syncopate';color:#fff;border-left:3px solid var(--neon);padding-left:10px;font-weight:700;margin-bottom:30px;font-size:1.1rem;cursor:pointer}
    .nav-btn{padding:12px 15px;background:transparent;border:1px solid transparent;color:#888;text-align:left;font-family:'Syncopate';font-size:0.7rem;cursor:pointer;transition:0.3s;display:flex;align-items:center;gap:10px}
    .nav-btn:hover, .nav-btn.active{background:rgba(0,242,255,0.1);border-color:var(--neon);color:#fff}
    .bottom-link{margin-top:auto;border-top:1px solid var(--border);padding-top:20px}

    /* MOBILE HAMBURGER */
    .menu-toggle { display: none; position: fixed; top: 15px; left: 15px; z-index: 4000; background: #000; border: 1px solid var(--neon); color: var(--neon); padding: 5px 10px; font-size: 1.2rem; cursor: pointer; }

    /* MAIN CONTENT */
    .main{flex:1;padding:30px;overflow-y:auto;position:relative}
    .section{display:none;animation:fadeIn 0.5s}
    .section.active{display:block}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

    h1{font-family:'Syncopate';color:var(--neon);margin-bottom:20px;font-size:1.5rem}
    h2.sub-header{font-family:'Syncopate';color:var(--gold);font-size:1rem;margin:40px 0 20px;border-bottom:1px solid rgba(255,255,255,0.1);padding-bottom:10px}
    h2.cat-header{font-family:'Syncopate';color:#888;font-size:1rem;margin:30px 0 15px;border-bottom:1px solid rgba(255,255,255,0.1);padding-bottom:5px}

    /* CONTROLS (FILTERS & EXPORT) */
    .controls-bar { display:flex; gap:15px; margin-bottom:20px; align-items:center; background:var(--panel); padding:15px; border:1px solid var(--border); flex-wrap: wrap; }
    .date-picker { background:#000; color:#fff; border:1px solid #333; padding:8px; font-family:'Inter'; text-transform:uppercase; color-scheme:dark; }
    .export-btn { background:var(--success); color:#000; border:none; padding:8px 15px; font-weight:700; cursor:pointer; font-size:0.7rem; font-family:'Syncopate'; display:flex; align-items:center; gap:5px; }
    .export-btn:hover { box-shadow:0 0 10px var(--success); }

    /* HUD STATS */
    .hud-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:40px}
    .hud-card{background:var(--panel);border:1px solid var(--border);padding:20px;text-align:center}
    .hud-val{font-size:2.5rem;font-weight:800;color:#fff;margin:10px 0}
    .hud-label{font-family:'Syncopate';font-size:0.6rem;color:#888}

    /* DATA TABLES (SCROLLABLE ON MOBILE) */
    .table-container{background:var(--panel);border:1px solid var(--border);overflow-x:auto; margin-bottom: 30px; -webkit-overflow-scrolling: touch; }
    table{width:100%;border-collapse:collapse;font-size:0.85rem; min-width: 600px; /* Forces scroll on small screens */ }
    th,td{padding:15px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.05)}
    th{font-family:'Syncopate';color:var(--neon);font-size:0.7rem;background:rgba(0,0,0,0.5)}
    tr:hover{background:rgba(0,242,255,0.02)}
    .status-badge{padding:3px 8px;border-radius:3px;font-size:0.65rem;font-weight:700;text-transform:uppercase}
    .st-guest{background:#333;color:#aaa}
    .st-standard{background:#0044ff;color:#fff}
    .st-premium{background:var(--neon);color:#000}
    .st-elite{background:var(--gold);color:#000;box-shadow:0 0 10px var(--gold)}

    /* ACTIONS & FORMS */
    .action-btn{padding:5px 10px;border:1px solid var(--border);background:transparent;color:#fff;cursor:pointer;font-size:0.7rem;margin-right:5px;transition:0.2s}
    .action-btn:hover{background:var(--neon);color:#000}
    .btn-delete:hover{background:var(--warn);border-color:var(--warn)}
    
    .cms-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:20px}
    .cms-card{background:var(--panel);border:1px solid var(--border);padding:15px;position:relative}
    .cms-img{width:100%;height:150px;object-fit:cover;margin-bottom:10px;background:#000}
    
    input, textarea, select{width:100%;padding:10px;background:#000;border:1px solid #333;color:#fff;margin-bottom:10px;font-family:'Inter'; font-size:16px;} /* iOS Fix */
    input:focus{border-color:var(--neon);outline:none}
    
    .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:2000;place-items:center}
    .modal-box{background:#0a0f14;padding:30px;border:1px solid var(--neon);width:90%;max-width:500px}

    
    /* MOBILE BREAKPOINTS */
    @media (max-width: 768px) {
        .menu-toggle { 
            display: block; 
            top: 20px; 
            left: 20px; 
            /* Ensure button stays on top of sidebar when open */
            z-index: 4000; 
        }
        
        .sidebar { 
            position: fixed; 
            top: 0; 
            left: 0; 
            height: 100%; 
            transform: translateX(-100%); 
            width: 80%; 
            /* Add top padding so Logo doesn't hit the top edge */
            padding-top: 80px; 
        }
        
        .sidebar.active { 
            transform: translateX(0); 
            box-shadow: 10px 0 30px rgba(0,0,0,0.8);
        }

        /* Adjust Logo position inside Sidebar for Mobile */
        .sidebar .logo {
            position: absolute;
            top: 25px;
            left: 70px; /* Push logo right to avoid hamburger overlap */
            font-size: 1rem;
            margin: 0;
        }

        .main { 
            /* Push main content down so it doesn't hide behind the absolute hamburger */
            padding: 80px 15px 15px; 
        } 
        
        h1 { font-size: 1.2rem; }
        .hud-grid { grid-template-columns: 1fr; }
        .controls-bar { flex-direction: column; align-items: flex-start; }
        .date-picker, .export-btn { width: 100%; }
    }
</style>
</head>
<body>

<button class="menu-toggle" onclick="toggleSidebar()">☰</button>

<aside class="sidebar" id="adminSidebar">
    <div class="logo">RAAYA<span style="color:var(--neon)">//</span>ADMIN</div>
    <button class="nav-btn active" onclick="switchTab('dashboard')">DATA HUD</button>
    <button class="nav-btn" onclick="switchTab('sales')">REVENUE STREAM</button>
    <button class="nav-btn" onclick="switchTab('members')">MEMBERS</button>
    <button class="nav-btn" onclick="switchTab('comms')">COMMS</button>
    <div style="border-top:1px solid #333;margin:10px 0"></div>
    <button class="nav-btn" onclick="switchTab('cms-tiers')">CMS: TIERS</button>
    <button class="nav-btn" onclick="switchTab('cms-facilities')">CMS: FACILITIES</button>
    <button class="nav-btn" onclick="switchTab('cms-vault')">CMS: VAULT</button>
    
    <div class="bottom-link">
        <a href="index.html?mode=preview" class="nav-btn" style="color:var(--success)">
            <svg viewBox="0 0 24 24" style="width:16px;height:16px;fill:currentColor;margin-right:10px"><path d="M12 2L2 12h3v8h6v-6h2v6h6v-8h3L12 2z"/></svg> 
            LIVE SITE
        </a>
        <button class="nav-btn" onclick="handleLogout()" style="color:var(--warn);margin-top:10px">LOGOUT</button>
    </div>
</aside>

<main class="main">
    
    <div id="dashboard" class="section active">
        <h1>COMMAND DECK</h1>
        <div class="hud-grid">
            <div class="hud-card">
                <div class="hud-val" id="stat-total">0</div>
                <div class="hud-label">TOTAL OPERATIVES</div>
            </div>
            <div class="hud-card" style="border-color:var(--gold)">
                <div class="hud-val" id="stat-revenue">₹0</div>
                <div class="hud-label">MONTHLY RECURRING (EST)</div>
            </div>
            <div class="hud-card" style="border-color:var(--success)">
                <div class="hud-val" id="stat-elite">0%</div>
                <div class="hud-label">ELITE RATIO</div>
            </div>
        </div>
    </div>

    <div id="sales" class="section">
        <h1>REVENUE STREAM</h1>
        
        <div class="controls-bar">
            <label style="font-size:0.7rem;color:#888">FILTER MONTH:</label>
            <input type="month" id="salesMonth" class="date-picker" onchange="loadSales()">
            <button class="export-btn" onclick="exportData('sales')">⬇ EXPORT CSV</button>
        </div>

        <div class="hud-grid">
            <div class="hud-card" style="border-color:var(--success)">
                <div class="hud-val" id="sale-total">₹0</div>
                <div class="hud-label">TOTAL REVENUE (PERIOD)</div>
            </div>
            <div class="hud-card">
                <div class="hud-val" id="sale-mem">₹0</div>
                <div class="hud-label">MEMBERSHIPS</div>
            </div>
            <div class="hud-card">
                <div class="hud-val" id="sale-prod">₹0</div>
                <div class="hud-label">PRODUCTS</div>
            </div>
        </div>

        <h2 class="sub-header">MEMBERSHIP ACQUISITIONS</h2>
        <div class="table-container">
            <table id="salesMemTable">
                <thead><tr><th>Date</th><th>Name</th><th>Tier Purchased</th><th>Amount</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <h2 class="sub-header">VAULT SALES</h2>
        <div class="table-container">
            <table id="salesProdTable">
                <thead><tr><th>Date</th><th>Name</th><th>Item Acquired</th><th>Amount</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="members" class="section">
        <h1>MEMBER ROSTER</h1>
        <div class="controls-bar">
            <label style="font-size:0.7rem;color:#888">FILTER JOIN MONTH:</label>
            <input type="month" id="memberMonth" class="date-picker" onchange="loadMembers()">
            <button class="export-btn" onclick="exportData('members')">⬇ EXPORT CSV</button>
        </div>
        <div class="table-container">
            <table id="membersTable">
                <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Age</th><th>Tier</th><th>Joined</th><th>Actions</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="comms" class="section">
        <h1>INCOMING TRANSMISSIONS</h1>
        <div class="controls-bar">
            <label style="font-size:0.7rem;color:#888">FILTER MONTH:</label>
            <input type="month" id="commsMonth" class="date-picker" onchange="loadComms()">
            <button class="export-btn" onclick="exportData('comms')">⬇ EXPORT CSV</button>
        </div>
        <div class="table-container">
            <table id="commsTable">
                <thead><tr><th>Date</th><th>Sender</th><th>Contact</th><th>Message</th><th>Actions</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="cms-tiers" class="section">
        <h1>ACCESS PROTOCOLS (TIERS)</h1>
        <div id="tiers-container" class="cms-grid"></div>
    </div>

    <div id="cms-facilities" class="section">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
            <h1>FACILITIES</h1>
            <button class="action-btn" onclick="openModal('facility')">+ ADD NEW</button>
        </div>
        <div id="facilities-container" class="cms-grid"></div>
    </div>

    <div id="cms-vault" class="section">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
            <h1>ARMORY (VAULT)</h1>
            <button class="action-btn" onclick="openModal('product')">+ ADD ITEM</button>
        </div>
        <div id="vault-container"></div>
    </div>

</main>

<div id="modal" class="modal-overlay">
    <div class="modal-box">
        <h2 id="modalTitle" style="font-family:'Syncopate';color:var(--neon);margin-bottom:20px">EDIT ITEM</h2>
        <form id="modalForm">
            <input type="hidden" id="editId">
            <input type="hidden" id="editType">
            
            <input type="text" id="inpName" placeholder="Name/Title" required>
            <textarea id="inpDesc" placeholder="Description/Features (Comma separated)" rows="3"></textarea>
            <input type="number" id="inpPrice" placeholder="Price (if applicable)">
            
            <label style="font-size:0.7rem;color:#888">IMAGE URL OR UPLOAD</label>
            <input type="text" id="inpUrl" placeholder="Image URL">
            <input type="file" id="inpFile" accept="image/*">
            
            <select id="inpCat" style="display:none">
                <option value="supplements">Supplements</option>
                <option value="gear">Gear</option>
                <option value="apparel">Apparel</option>
            </select>

            <button type="submit" class="nav-btn" style="background:var(--neon);color:#000;width:100%;justify-content:center;margin-top:10px;font-weight:700">SAVE DATA</button>
            <button type="button" class="nav-btn" onclick="closeModal()" style="width:100%;justify-content:center;margin-top:5px;color:var(--warn)">CANCEL</button>
        </form>
    </div>
</div>

<script type="module">
import{createClient}from'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
const sb=createClient('https://rpgygmrhkmevhneebbxo.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJwZ3lnbXJoa21ldmhuZWViYnhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzOTkzNDYsImV4cCI6MjA4Mzk3NTM0Nn0.Haf3zKhLVzW_uBWckv_O2pdfYABWaDiExP1Kwckjrpc')

let currentSalesData = [];
let currentMembersData = [];
let currentCommsData = [];

// --- MOBILE SIDEBAR TOGGLE ---
window.toggleSidebar = () => {
    document.getElementById('adminSidebar').classList.toggle('active');
}

// --- INITIALIZATION ---
window.onload = async () => {
    // 1. GATEKEEPER
    const { data: { session } } = await sb.auth.getSession();
    if (!session) window.location.href = 'index.html';
    
    const { data: profile } = await sb.from('profiles').select('is_admin').eq('id', session.user.id).single();
    if (!profile || !profile.is_admin) {
        alert("ACCESS DENIED");
        window.location.href = 'index.html';
        return;
    }

    // Set Default Month (Current)
    const today = new Date().toISOString().slice(0, 7); // YYYY-MM
    document.getElementById('salesMonth').value = today;
    document.getElementById('memberMonth').value = ""; // Default show all for members
    document.getElementById('commsMonth').value = "";

    // 2. LOAD DATA
    loadDashboard();
    loadSales();
    loadMembers();
    loadComms();
    loadCMS();
}

window.switchTab = (id) => {
    document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    event.target.classList.add('active');
    
    // Auto-close sidebar on mobile after clicking
    if(window.innerWidth < 768) {
        document.getElementById('adminSidebar').classList.remove('active');
    }
}

// --- LOGIC: EXPORT ---
window.exportData = (type) => {
    let data = [];
    let filename = `raaya_${type}_export.csv`;
    
    if(type === 'sales') data = currentSalesData;
    else if(type === 'members') data = currentMembersData;
    else if(type === 'comms') data = currentCommsData;

    if(!data || data.length === 0) { alert("No data to export."); return; }

    const header = Object.keys(data[0]).join(",");
    const rows = data.map(obj => Object.values(obj).map(val => `"${val}"`).join(",")); 
    const csv = [header, ...rows].join("\n");

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
}

// --- LOGIC: DASHBOARD ---
async function loadDashboard() {
    const { count: totalUsers } = await sb.from('profiles').select('*', { count: 'exact', head: true });
    const { data: elites } = await sb.from('profiles').select('membership_tier').eq('membership_tier', 'Elite');
    
    const { data: premiums } = await sb.from('profiles').select('membership_tier').eq('membership_tier', 'Premium');
    const { data: standards } = await sb.from('profiles').select('membership_tier').eq('membership_tier', 'Standard');
    const rev = (elites.length * 2499) + (premiums.length * 1999) + (standards.length * 999);
    
    document.getElementById('stat-total').innerText = totalUsers;
    document.getElementById('stat-revenue').innerText = "₹" + rev.toLocaleString();
    document.getElementById('stat-elite').innerText = totalUsers ? Math.round((elites.length / totalUsers) * 100) + "%" : "0%";
}

// --- LOGIC: SALES (With Filter) ---
window.loadSales = async () => {
    const month = document.getElementById('salesMonth').value; // YYYY-MM
    let query = sb.from('sales_ledger').select('*').order('created_at', { ascending: false });

    if(month) {
        const start = `${month}-01`;
        const end = `${month}-31`; 
        query = query.gte('created_at', start).lte('created_at', end);
    }

    const { data: ledger } = await query;
    currentSalesData = ledger || [];

    if(!ledger) return;

    let totalRev = 0, memRev = 0, prodRev = 0;
    const memBody = document.querySelector('#salesMemTable tbody');
    const prodBody = document.querySelector('#salesProdTable tbody');
    memBody.innerHTML = '';
    prodBody.innerHTML = '';

    ledger.forEach(txn => {
        totalRev += txn.amount;
        const date = new Date(txn.created_at).toLocaleDateString();
        
        const row = `<tr><td>${date}</td><td style="color:var(--neon)">${txn.user_name || 'Unknown'}</td><td>${txn.item_name}</td><td style="color:var(--success);font-weight:700">₹${txn.amount}</td></tr>`;

        if (txn.category === 'Membership') { memRev += txn.amount; memBody.innerHTML += row; } 
        else { prodRev += txn.amount; prodBody.innerHTML += row; }
    });

    document.getElementById('sale-total').innerText = "₹" + totalRev.toLocaleString();
    document.getElementById('sale-mem').innerText = "₹" + memRev.toLocaleString();
    document.getElementById('sale-prod').innerText = "₹" + prodRev.toLocaleString();
}

// --- LOGIC: MEMBERS (With Filter) ---
window.loadMembers = async () => {
    const month = document.getElementById('memberMonth').value;
    let query = sb.from('profiles').select('*').order('created_at', { ascending: false });

    if(month) {
        query = query.gte('created_at', `${month}-01`).lte('created_at', `${month}-31`);
    }

    const { data } = await query;
    currentMembersData = data || [];

    const tbody = document.querySelector('#membersTable tbody');
    tbody.innerHTML = data.map(u => `
        <tr>
            <td>${u.full_name || 'Unknown'}</td>
            <td><span style="opacity:0.6">${u.email || 'N/A'}</span></td>
            <td>${u.phone || '-'}</td>
            <td>${u.age || '-'}</td>
            <td><span class="status-badge st-${u.membership_tier ? u.membership_tier.toLowerCase() : 'guest'}">${u.membership_tier || 'Guest'}</span></td>
            <td>${new Date(u.created_at).toLocaleDateString()}</td>
            <td>
                <select onchange="updateTier('${u.id}', this.value)" style="width:auto;padding:2px;margin:0">
                    <option value="" disabled selected>Tier</option>
                    <option value="Guest">Guest</option>
                    <option value="Standard">Standard</option>
                    <option value="Premium">Premium</option>
                    <option value="Elite">Elite</option>
                </select>
                <button class="action-btn btn-delete" onclick="deleteUser('${u.id}')">BAN</button>
            </td>
        </tr>
    `).join('');
}

window.updateTier = async (id, tier) => {
    await sb.from('profiles').update({ membership_tier: tier }).eq('id', id);
    loadDashboard(); loadMembers();
}
window.deleteUser = async (id) => {
    // Confirm with the Admin first
    if(confirm("PERFORM HARD DELETE? This will wipe the user from Authentication and Database. Sales history will be preserved but anonymized.")) {
        
        // Call the Secure Database Function (RPC)
        const { error } = await sb.rpc('delete_user_completely', { target_user_id: id });

        if (error) {
            alert("Error: " + error.message);
            console.error(error);
        } else {
            alert("USER TERMINATED SUCCESSFULLY.");
            loadMembers();    // Refresh Member List
            loadDashboard();  // Refresh Stats
        }
    }
}
// --- LOGIC: COMMS (With Filter) ---
window.loadComms = async () => {
    const month = document.getElementById('commsMonth').value;
    let query = sb.from('contact_messages').select('*').order('created_at', { ascending: false });

    if(month) {
        query = query.gte('created_at', `${month}-01`).lte('created_at', `${month}-31`);
    }

    const { data } = await query;
    currentCommsData = data || [];

    document.querySelector('#commsTable tbody').innerHTML = data.map(m => `
        <tr>
            <td>${new Date(m.created_at).toLocaleDateString()}</td>
            <td>${m.name}</td>
            <td>${m.email}<br>${m.phone}</td>
            <td style="max-width:300px;overflow:hidden;text-overflow:ellipsis">${m.question}</td>
            <td><button class="action-btn btn-delete" onclick="deleteMsg('${m.id}')">X</button></td>
        </tr>
    `).join('');
}
window.deleteMsg = async(id) => { await sb.from('contact_messages').delete().eq('id', id); loadComms(); }

// --- LOGIC: CMS (TIERS, FACILITIES, VAULT) ---
async function loadCMS() {
    // 1. Tiers
    const { data: tiers } = await sb.from('membership_tiers').select('*').order('price');
    if(tiers) {
        document.getElementById('tiers-container').innerHTML = tiers.map(t => `
            <div class="cms-card">
                <h3 style="color:var(--neon)">${t.name}</h3>
                <h2 style="margin:10px 0">₹${t.price}</h2>
                <div style="font-size:0.8rem;color:#888">${t.features.join(', ')}</div>
                <button class="action-btn" onclick='editItem("tier", ${JSON.stringify(t)})' style="width:100%;margin-top:15px">EDIT</button>
            </div>
        `).join('');
    }

    // 2. Facilities
    const { data: facs } = await sb.from('facilities').select('*');
    if(facs) {
        document.getElementById('facilities-container').innerHTML = facs.map(f => `
            <div class="cms-card">
                <img src="${f.image_url}" class="cms-img">
                <h4>${f.name}</h4>
                <p style="font-size:0.7rem;color:#888;margin:5px 0">${f.description}</p>
                <div style="display:flex">
                    <button class="action-btn" onclick='editItem("facility", ${JSON.stringify(f)})'>EDIT</button>
                    <button class="action-btn btn-delete" onclick="deleteItem('facilities', ${f.id})">DEL</button>
                </div>
            </div>
        `).join('');
    }

    // 3. Vault (Categorized)
    const { data: prods } = await sb.from('vault_products').select('*');
    if(prods) {
        const categories = ['supplements', 'gear', 'apparel'];
        const container = document.getElementById('vault-container');
        container.innerHTML = '';
        
        categories.forEach(cat => {
            const items = prods.filter(p => p.category === cat);
            if(items.length > 0) {
                container.innerHTML += `<h2 class="cat-header">${cat.toUpperCase()}</h2>`;
                container.innerHTML += `<div class="cms-grid">` + items.map(p => `
                    <div class="cms-card">
                        <img src="${p.image_url}" class="cms-img">
                        <h4>${p.name}</h4>
                        <div style="color:var(--gold);font-weight:700">₹${p.price}</div>
                        <div style="display:flex;margin-top:10px">
                            <button class="action-btn" onclick='editItem("product", ${JSON.stringify(p)})'>EDIT</button>
                            <button class="action-btn btn-delete" onclick="deleteItem('vault_products', ${p.id})">DEL</button>
                        </div>
                    </div>
                `).join('') + `</div>`;
            }
        });
    }
}

// --- CMS ACTIONS ---
window.deleteItem = async (table, id) => {
    if(confirm("DELETE ASSET?")) {
        await sb.from(table).delete().eq('id', id);
        loadCMS();
    }
}

window.openModal = (type) => {
    document.getElementById('modal').style.display = 'grid';
    document.getElementById('modalForm').reset();
    document.getElementById('editId').value = '';
    document.getElementById('editType').value = type;
    document.getElementById('modalTitle').innerText = "ADD NEW " + type.toUpperCase();
    
    document.getElementById('inpPrice').style.display = (type === 'tier' || type === 'product') ? 'block' : 'none';
    document.getElementById('inpCat').style.display = (type === 'product') ? 'block' : 'none';
    document.getElementById('inpDesc').placeholder = (type === 'tier') ? "Features (comma separated)" : "Description";
}

window.editItem = (type, obj) => {
    openModal(type);
    document.getElementById('modalTitle').innerText = "EDIT " + type.toUpperCase();
    document.getElementById('editId').value = obj.id;
    
    document.getElementById('inpName').value = obj.name;
    if(obj.price) document.getElementById('inpPrice').value = obj.price;
    if(obj.image_url) document.getElementById('inpUrl').value = obj.image_url;
    
    if(type === 'tier') document.getElementById('inpDesc').value = obj.features.join(', ');
    else if(obj.description) document.getElementById('inpDesc').value = obj.description;
    
    if(obj.category) document.getElementById('inpCat').value = obj.category;
}

window.closeModal = () => document.getElementById('modal').style.display = 'none';

document.getElementById('modalForm').onsubmit = async (e) => {
    e.preventDefault();
    const id = document.getElementById('editId').value;
    const type = document.getElementById('editType').value;
    const name = document.getElementById('inpName').value;
    const price = document.getElementById('inpPrice').value;
    const desc = document.getElementById('inpDesc').value;
    let url = document.getElementById('inpUrl').value;
    const file = document.getElementById('inpFile').files[0];
    const category = document.getElementById('inpCat').value;

    if (file) {
        const fileExt = file.name.split('.').pop();
        const fileName = `${Math.random()}.${fileExt}`;
        const { data, error } = await sb.storage.from('gym-images').upload(fileName, file);
        if (!error) {
            const { data: { publicUrl } } = sb.storage.from('gym-images').getPublicUrl(fileName);
            url = publicUrl;
        } else {
            alert("Upload failed: " + error.message);
        }
    }

    let table = '', payload = {};

    if (type === 'tier') {
        table = 'membership_tiers';
        payload = { name, price, features: desc.split(',').map(s=>s.trim()) };
    } else if (type === 'facility') {
        table = 'facilities';
        payload = { name, description: desc, image_url: url };
    } else if (type === 'product') {
        table = 'vault_products';
        payload = { name, price, category, image_url: url };
    }

    if (id) await sb.from(table).update(payload).eq('id', id);
    else await sb.from(table).insert([payload]);

    closeModal();
    loadCMS();
}

window.handleLogout = async () => {
    await sb.auth.signOut();
    window.location.href = 'index.html';
}
</script>
</body>
</html>